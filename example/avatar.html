<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex,nofollow" />
    <meta name="referrer" content="no-referrer" />
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      canvas {
        box-sizing: border-box;
      }
      .dragging {
        border: dashed 10px #668cff;
      }
      .start {
        position: absolute;
        z-index: 1;
        inset: 0;
        margin: auto;
        width: fit-content;
        height: fit-content;
        pointer-events: none;
      }
      .message {
        font-size: 1.2rem;
        color: #999;
        border-radius: 0.5em;
        background: #eee;
        padding: 2em;
        text-align: center;
      }
      #controls {
        position: absolute;
        left: 100px;
        z-index: 1;
        display: flex;
        flex-direction: row;
        align-items: center;
        column-gap: 1rem;
      }
      #controls * {
        font-size: 0.8rem;
      }
      #controls label {
        display: flex;
        flex-direction: row;
        align-items: center;
      }
    </style>
    <script
      async
      src="https://cdn.jsdelivr.net/npm/es-module-shims@1.6.2/dist/es-module-shims.min.js"
    ></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.module.js",
          "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.149.0/examples/jsm/",
          "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@1.0.8/lib/three-vrm.module.js",
          "three-avatar": "../dist/esm/index.js",
          "./setup": "./setup.js"
        }
      }
    </script>
    <script type="module">
      import { setupScene } from "./setup";
      import * as THREE from "three";
      import {
        isAnimationDataLoaded,
        preLoadAnimationData,
        createAvatar,
        isLowSpecDevice,
      } from "three-avatar";

      const AVATARS = [
        "asset/avatar-example/mochi.vrm",
        "asset/avatar-example/iroha.vrm",
        "asset/avatar-example/vrm-v1.vrm",
        "asset/avatar-example/vrm-v0.vrm",
        "asset/avatar-example/rpm.glb",
      ];
      const ANIMATION_MAP = {
        idle: "asset/animation/idle.fbx",
        walk: "asset/animation/walk.fbx",
        dance: "asset/animation/Breakdance Uprock Var 1.fbx",
      };

      const avatars = [];

      const ctx = setupScene(
        (dt) => {
          for (const avatar of avatars) {
            avatar.tick(dt);
          }
        },
        false,
        true
      );
      ctx.scene.add(ctx.cameraContainer);

      const canvas = ctx.renderer.domElement;
      const startPane = document.querySelector(".start");
      let isDragging = false;

      const dragLeave = () => {
        if (isDragging) {
          isDragging = false;
          canvas.classList.remove("dragging");
        }
      };
      const isAllowEvent = (e) => {
        if (e.dataTransfer?.items.length !== 1) {
          return false;
        }
        const item = e.dataTransfer.items[0];
        if (item.kind && item.kind !== "file") {
          return false;
        }
        const f = e.dataTransfer?.files[0];
        if (f?.name) {
          const name = f.name.toLowerCase();
          if (
            !["glb", "vrm"].find((v) => name.toLowerCase().endsWith(`.${v}`))
          ) {
            return false;
          }
        }
        return true;
      };
      for (const el of [canvas, startPane]) {
        el.addEventListener("dragover", (e) => {
          e.preventDefault();
          if (!isAllowEvent(e)) {
            e.preventDefault();
            return;
          }
          if (!isDragging) {
            isDragging = true;
            canvas.classList.add("dragging");
          }
        });
        el.addEventListener("dragleave", (e) => {
          e.preventDefault();
          dragLeave();
        });
        el.addEventListener("dragend", (e) => {
          e.preventDefault();
          dragLeave();
        });
        el.addEventListener("drop", (e) => {
          e.preventDefault();
          dragLeave();
          if (!isAllowEvent(e)) {
            e.preventDefault();
            return;
          }
          const file = e.dataTransfer.files[0];
          setAvatar(file);
        });
      }
      document.querySelector('#avatarFile').addEventListener('change', (e) => {
        if(e.target.files.length !== 1){
          return;
        }
        setAvatar(e.target.files[0]);
      });
      const isLowSpecMode = true; //isLowSpecDevice();
      const setAvatar = async (file) => {
        startPane.parentNode?.removeChild(startPane);
        if (!isAnimationDataLoaded()) {
          await preLoadAnimationData(ANIMATION_MAP);
        }
        for (const avatar of avatars) {
          avatar.dispose();
        }
        avatars.length = 0;

        const avatarData = new Uint8Array(await file.arrayBuffer());

        const numOfAvatars = parseInt(document.querySelector('#numOfAvatars').value, 10);

        for(let i = 0; i < numOfAvatars; i++){
          const avatar = await createAvatar(avatarData, ctx.renderer, false, {
            isLowSpecMode,
            animationIntervalSec: isLowSpecMode ? 1 / 30 : 1 / 60,
          });
          avatar.object3D.rotation.y = THREE.MathUtils.degToRad(180);
          const pos = i % 10;
          avatar.object3D.position.set(
            ((pos === 0 ? 0 : pos % 2 === 0 ? 0.5 : -0.5) * (pos / 2)) + Math.floor(i / 10) * 0.2,
            0, 
            Math.floor(i / 10) * -0.5 - 2,
          );
          ctx.scene.add(avatar.object3D);
          avatar.object3D.updateMatrixWorld();
          avatars.push(avatar);
        }
      };
    </script>
  </head>
  <body>
    <div id="controls">
      <label>Num of avatars: 
        <input type="number" id="numOfAvatars" min="1" value="10" step="1"></input>
      </label>
      <label>Avatar file (glb, vrm): 
        <input type="file" id="avatarFile" accept=".glb,.vrm"></input>
      </label>
    </div>
    <div class="start">
      <div class="message">Drag avatar file here (glb, vrm).</div>
    </div>
  </body>
</html>
